name: NBA daily box scores

on:
  schedule:
    - cron: "30 9 * * *"   # 11:30 Israel time most of the year
  workflow_dispatch:
    inputs:
      mode:
        description: 'Ingestion mode'
        required: true
        default: 'daily'
        type: choice
        options:
          - daily
          - specific_date
          - backfill
      specific_date:
        description: 'For specific_date mode: YYYY-MM-DD (e.g., 2025-11-07)'
        required: false
        type: string
      start_date:
        description: 'For backfill mode: start date YYYY-MM-DD'
        required: false
        type: string
      end_date:
        description: 'For backfill mode: end date YYYY-MM-DD'
        required: false
        type: string

jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Validate inputs
        if: github.event_name == 'workflow_dispatch'
        run: |
          MODE="${{ github.event.inputs.mode }}"
          
          if [ "$MODE" = "specific_date" ]; then
            if [ -z "${{ github.event.inputs.specific_date }}" ]; then
              echo "‚ùå specific_date mode requires specific_date parameter"
              exit 1
            fi
            # Validate date format
            if ! date -d "${{ github.event.inputs.specific_date }}" >/dev/null 2>&1; then
              echo "‚ùå Invalid date format. Use YYYY-MM-DD"
              exit 1
            fi
          fi
          
          if [ "$MODE" = "backfill" ]; then
            if [ -z "${{ github.event.inputs.start_date }}" ] || [ -z "${{ github.event.inputs.end_date }}" ]; then
              echo "‚ùå backfill mode requires start_date and end_date parameters"
              exit 1
            fi
            if ! date -d "${{ github.event.inputs.start_date }}" >/dev/null 2>&1; then
              echo "‚ùå Invalid start_date format. Use YYYY-MM-DD"
              exit 1
            fi
            if ! date -d "${{ github.event.inputs.end_date }}" >/dev/null 2>&1; then
              echo "‚ùå Invalid end_date format. Use YYYY-MM-DD"
              exit 1
            fi
          fi
      
      - name: Ingest - Daily (scheduled)
        if: github.event_name == 'schedule'
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          BQ_DATASET: ${{ secrets.BQ_DATASET }}
        run: |
          echo "üèÄ Running scheduled daily ingestion for yesterday"
          python nba_ingest.py --mode daily
      
      - name: Ingest - Daily (manual)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'daily'
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          BQ_DATASET: ${{ secrets.BQ_DATASET }}
        run: |
          echo "üèÄ Running manual daily ingestion for yesterday"
          python nba_ingest.py --mode daily
      
      - name: Ingest - Specific Date
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'specific_date'
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          BQ_DATASET: ${{ secrets.BQ_DATASET }}
        run: |
          echo "üìÖ Running ingestion for specific date: ${{ github.event.inputs.specific_date }}"
          python nba_ingest.py --date "${{ github.event.inputs.specific_date }}"
      
      - name: Ingest - Backfill Range
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'backfill'
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          BQ_DATASET: ${{ secrets.BQ_DATASET }}
        run: |
          echo "üì¶ Running backfill from ${{ github.event.inputs.start_date }} to ${{ github.event.inputs.end_date }}"
          python nba_ingest.py --mode backfill --start "${{ github.event.inputs.start_date }}" --end "${{ github.event.inputs.end_date }}"
      
      - name: Check for errors
        if: failure()
        run: |
          echo "üö® Job failed! Check logs above for details."
          exit 1
